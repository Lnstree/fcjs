var fcgame=function(t){var i={};function r(s){if(i[s])return i[s].exports;var e=i[s]={i:s,l:!1,exports:{}};return t[s].call(e.exports,e,e.exports,r),e.l=!0,e.exports}return r.m=t,r.c=i,r.d=function(t,i,s){r.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,i){if(1&i&&(t=r(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var e in t)r.d(s,e,function(i){return t[i]}.bind(null,e));return s},r.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(i,"a",i),i},r.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},r.p="",r(r.s=0)}([function(t,i,r){"use strict";r.r(i),r.d(i,"FC_Game",(function(){return p})),r.d(i,"FC_Display",(function(){return u}));var s=r(1),e=r(2),n=r(3),h=r(5),a=r(6),o=r(7),c=function(){this.cpu=new s(this),this.ppu=new e(this),this.cartridge=new n(this),this.player1=new a(this),this.player2=new a(this),this.joypad=new o(this)};function p(){return new c}function u(t){return new h(t)}c.prototype.player=function(t){return 0==t?this.player1:1==t?this.player2:void 0},c.prototype.loadFile=function(){},c.prototype.load=function(t){this.cartridge.load(t)},c.prototype.run=function(){setInterval(()=>{nes.cpu.run_frame()},1e3/60)},c.prototype.registerDisplay=function(t){this.ppu.set_display(t)},c.prototype.test=function(){console.log("Hello FC Game!")}},function(t,i){var r=0,s=1,e=2,n=3,h=0,a=1,o=2,c=3,p=6,u=7,d=function(){this.flag=32};d.prototype.get=function(){return this.flag},d.prototype.index=function(t){return!!(this.flag>>t&1)},d.prototype.setFlag=function(t,i){this.flag&=~(1<<t),this.flag|=(i>0)<<t},d.prototype.set=function(t){this.flag=255&(32|t)};var _=new Uint8Array(1),y=new Uint8Array(1),f=new Uint8Array(1),l=new Uint8Array(1),g=new d,b=new Uint16Array(1),m=new Uint8Array(2048),A=new Int16Array(1),w=new Uint16Array(1),k=new Uint16Array(1),v=new Uint16Array(1),z=new Uint8Array(1),x=new Uint8Array(1),R=new Int8Array(1),S=function(t){this.nes=t,this.nmi=!1,this.irq=!1,this.remaininhCycles=0};S.prototype.debugInfo=function(){console.log("A:",_[0]," X",y[0]," Y",f[0]," S",l[0]),console.log("PC:",b[0]),console.log("flag(","C:",g.index(h),"Z:",g.index(a),"I:",g.index(o),"D:",g.index(c),"V:",g.index(p),"N:",g.index(u),")"),console.log("nmi:",this.nmi),console.log("irq:",this.irq),console.log("cycles:",this.remaininhCycles),console.log("--------------------------------------------------")},S.prototype.set_nmi=function(t=!0){this.nmi=t},S.prototype.set_irq=function(t=!0){this.irq=t},S.prototype.dmc_read=function(t){return this.access(0,t)},S.prototype.elapsed=function(){return 29781-this.remaininhCycles},S.prototype.tick=function(){this.nes.ppu.step(),this.nes.ppu.step(),this.nes.ppu.step(),this.remaininhCycles--},S.prototype.upd_cv=function(t,i,r){g.setFlag(h,r>255),g.setFlag(p,~(t^i)&(t^r)&128)},S.prototype.upd_nz=function(t){z[0]=t,g.setFlag(u,128&z[0]),g.setFlag(a,0==z[0])},S.prototype.cross=function(t,i){return(t+i&65280)!=(65280&t)},S.prototype.dma_oam=function(t){for(var i=0;i<256;i++)this.wr(8212,this.rd(256*t+i))},S.prototype.access=function(t,i,r=0){if(i<=8191)return t&&(m[i%2048]=r),m[i%2048];if(i>=8192&&i<=16383)return this.nes.ppu.access(t,i%8,r);if(i>=16384&&i<=16403);else if(16405==i);else if(16404==i)t&&this.dma_oam(r);else{if(16407==i)return t?0:this.nes.joypad.read_state(1);if(16406==i){if(!t)return this.nes.joypad.read_state(0);this.nes.joypad.write_strobe(1&r)}else if(i>=16408&&i<=65535)return this.nes.cartridge.access(t,i,r)}return 0},S.prototype.wr=function(t,i){return this.tick(),this.access(1,t,i)},S.prototype.rd=function(t){return this.tick(),this.access(0,t)},S.prototype.rd16_d=function(t,i){return k[0]=this.rd(t),v[0]=this.rd(i)<<8,w[0]=k[0]|v[0],w[0]},S.prototype.rd16=function(t){return this.rd16_d(t,t+1)},S.prototype.push=function(t){return this.wr(256+l[0]--,t)},S.prototype.pop=function(t){return z[0]=this.rd(++l[0]+256),z[0]},S.prototype.imm=function(){return b[0]++},S.prototype.imm16=function(){return b[0]+=2,b[0]-2},S.prototype.abs=function(){return this.rd16(this.imm16())},S.prototype._abx=function(){return this.tick(),this.abs()+y[0]},S.prototype.abx=function(){var t=this.abs();return this.cross(t,y[0])&&this.tick(),t+y[0]},S.prototype.aby=function(){var t=this.abs();return this.cross(t,f[0])&&this.tick(),t+f[0]},S.prototype.zp=function(){return this.rd(b[0]++)},S.prototype.zpx=function(){return this.tick(),(this.zp()+y[0])%256},S.prototype.zpy=function(){return this.tick(),(this.zp()+f[0])%256},S.prototype.izx=function(){var t=this.zpx();return this.rd16_d(t,(t+1)%256)},S.prototype._izy=function(){var t=this.zp();return this.rd16_d(t,(t+1)%256)+f[0]},S.prototype.izy=function(){var t=this._izy();return this.cross(t-f[0],f[0])&&this.tick(),t},S.prototype.st=function(t,i){this.wr(i.bind(this)(),t)},S.prototype.st_A_izy=function(){this.tick(),this.wr(this._izy(),_[0])},S.prototype.st_A_abx=function(){this.tick(),this.wr(this.abs()+y[0],_[0])},S.prototype.st_A_aby=function(){this.tick(),this.wr(this.abs()+f[0],_[0])},S.prototype.ld=function(t,i){w[0]=i(),z[0]=this.rd(w[0]),t[0]=z[0],this.upd_nz(z[0])},S.prototype.cmp=function(t,i){w[0]=i(),z[0]=this.rd(w[0]),this.upd_nz(t-z[0]),g.setFlag(h,t>=z[0])},S.prototype.ADC=function(t){w[0]=t(),z[0]=this.rd(w[0]),A[0]=_[0]+z[0]+g.index(h),this.upd_cv(_[0],z[0],A[0]),_[0]=A[0],this.upd_nz(_[0])},S.prototype.SBC=function(t){w[0]=t(),z[0]=255^this.rd(w[0]),A[0]=_[0]+z[0]+g.index(h),this.upd_cv(_[0],z[0],A[0]),_[0]=A[0],this.upd_nz(_[0])},S.prototype.BIT=function(t){w[0]=t(),z[0]=this.rd(w[0]),g.setFlag(a,!(_[0]&z[0])),g.setFlag(u,128&z[0]),g.setFlag(p,64&z[0])},S.prototype.AND=function(t){w[0]=t(),z[0]=this.rd(w[0]),_[0]&=z[0],this.upd_nz(_[0])},S.prototype.EOR=function(t){w[0]=t(),z[0]=this.rd(w[0]),this.upd_nz(_[0]^=z[0])},S.prototype.ORA=function(t){w[0]=t(),z[0]=this.rd(w[0]),this.upd_nz(_[0]|=z[0])},S.prototype.ASL=function(t){new Uint16Array(1),new Uint8Array(1);w[0]=t(),z[0]=this.rd(w[0]),g.setFlag(h,128&z[0]),this.tick(),this.upd_nz(this.wr(w[0],z[0]<<1))},S.prototype.LSR=function(t){w[0]=t(),z[0]=this.rd(w[0]),g.setFlag(h,1&z[0]),this.tick(),this.upd_nz(this.wr(w[0],z[0]>>1))},S.prototype.ROL=function(t){w[0]=t(),z[0]=this.rd(w[0]),x[0]=g.index(h),g.setFlag(h,128&z[0]),this.tick(),this.upd_nz(this.wr(w[0],z[0]<<1|x[0]))},S.prototype.ROR=function(t){w[0]=t(),z[0]=this.rd(w[0]),x[0]=g.index(h)<<7,g.setFlag(h,1&z[0]),this.tick(),this.upd_nz(this.wr(w[0],x[0]|z[0]>>1))},S.prototype.DEC=function(t){w[0]=t(),z[0]=this.rd(w[0]),this.tick(),this.upd_nz(this.wr(w[0],--z[0]))},S.prototype.INC=function(t){w[0]=t(),z[0]=this.rd(w[0]),this.tick(),this.upd_nz(this.wr(w[0],++z[0]))},S.prototype.dec=function(t){t[0]=t[0]-1,this.upd_nz(t[0]),this.tick()},S.prototype.inc=function(t){t[0]=t[0]+1,this.upd_nz(t[0]),this.tick()},S.prototype.ASL_A=function(){g.setFlag(h,128&_[0]),_[0]=_[0]<<=1,this.upd_nz(_[0]),this.tick()},S.prototype.LSR_A=function(){g.setFlag(h,1&_[0]),_[0]=_[0]>>1,this.upd_nz(_[0]),this.tick()},S.prototype.ROL_A=function(){var t=g.index(h);g.setFlag(h,128&_[0]),_[0]=_[0]<<1,_[0]=_[0]|t,this.upd_nz(_[0]),this.tick()},S.prototype.ROR_A=function(){var t=g.index(h)<<7&255;g.setFlag(h,1&_[0]),_[0]=_[0]>>1,this.upd_nz(_[0]=t|_[0]),this.tick()},S.prototype.tr=function(t,i){i[0]=t[0],this.upd_nz(i[0]),this.tick()},S.prototype.tr_X_S=function(){l[0]=y[0],this.tick()},S.prototype.PLP=function(){this.tick(),this.tick();var t=this.pop();g.set(t)},S.prototype.PHP=function(){this.tick(),this.push(16|g.get())},S.prototype.PLA=function(){this.tick(),this.tick(),_[0]=this.pop(),this.upd_nz(_[0])},S.prototype.PHA=function(){this.tick(),this.push(_[0])},S.prototype.br=function(t,i){R[0]=this.rd(this.imm()),g.index(t)==i&&(this.tick(),b[0]+=R[0])},S.prototype.JMP_IND=function(){w[0]=this.rd16(this.imm16()),b[0]=this.rd16_d(w[0],65280&w[0]|(w[0]+1)%256)},S.prototype.JMP=function(){b[0]=this.rd16(this.imm16())},S.prototype.JSR=function(){var t=b[0]+1;this.tick(),this.push(t>>8),this.push(t),b[0]=this.rd16(this.imm16())},S.prototype.RTS=function(){this.tick(),this.tick(),b[0]=1+(this.pop()|this.pop()<<8),this.tick()},S.prototype.RTI=function(){this.PLP();var t=this.pop(),i=this.pop()<<8;b[0]=t|i},S.prototype.flag=function(t,i){g.setFlag(t,i),this.tick()},S.prototype.INT=function(t){this.tick(),t!=n&&this.tick(),t!=s?(this.push(b[0]>>8),this.push(255&b[0]),this.push(g.get()|(t==n)<<4)):(l[0]-=3,this.tick(),this.tick(),this.tick()),g.setFlag(o,!0);b[0]=this.rd16([65530,65532,65534,65534][t]),t==r&&(this.nmi=!1)},S.prototype.NOP=function(){this.tick()},S.prototype.exec=function(){switch(this.rd(b[0]++)){case 0:return this.INT(n);case 1:return this.ORA(this.izx.bind(this));case 5:return this.ORA(this.zp.bind(this));case 6:return this.ASL(this.zp.bind(this));case 8:return this.PHP();case 9:return this.ORA(this.imm.bind(this));case 10:return this.ASL_A();case 13:return this.ORA(this.abs.bind(this));case 14:return this.ASL(this.abs.bind(this));case 16:return this.br(u,0);case 17:return this.ORA(this.izy.bind(this));case 21:return this.ORA(this.zpx.bind(this));case 22:return this.ASL(this.zpx.bind(this));case 24:return this.flag(h,0);case 25:return this.ORA(this.aby.bind(this));case 29:return this.ORA(this.abx.bind(this));case 30:return this.ASL(this._abx.bind(this));case 32:return this.JSR();case 33:return this.AND(this.izx.bind(this));case 36:return this.BIT(this.zp.bind(this));case 37:return this.AND(this.zp.bind(this));case 38:return this.ROL(this.zp.bind(this));case 40:return this.PLP();case 41:return this.AND(this.imm.bind(this));case 42:return this.ROL_A();case 44:return this.BIT(this.abs.bind(this));case 45:return this.AND(this.abs.bind(this));case 46:return this.ROL(this.abs.bind(this));case 48:return this.br(u,1);case 49:return this.AND(this.izy.bind(this));case 53:return this.AND(this.zpx.bind(this));case 54:return this.ROL(this.zpx.bind(this));case 56:return this.flag(h,1);case 57:return this.AND(this.aby.bind(this));case 61:return this.AND(this.abx.bind(this));case 62:return this.ROL(this._abx.bind(this));case 64:return this.RTI();case 65:return this.EOR(this.izx.bind(this));case 69:return this.EOR(this.zp.bind(this));case 70:return this.LSR(this.zp.bind(this));case 72:return this.PHA();case 73:return this.EOR(this.imm.bind(this));case 74:return this.LSR_A();case 76:return this.JMP();case 77:return this.EOR(this.abs.bind(this));case 78:return this.LSR(this.abs.bind(this));case 80:return this.br(p,0);case 81:return this.EOR(this.izy.bind(this));case 85:return this.EOR(this.zpx.bind(this));case 86:return this.LSR(this.zpx.bind(this));case 88:return this.flag(o,0);case 89:return this.EOR(this.aby.bind(this));case 93:return this.EOR(this.abx.bind(this));case 94:return this.LSR(this._abx.bind(this));case 96:return this.RTS();case 97:return this.ADC(this.izx.bind(this));case 101:return this.ADC(this.zp.bind(this));case 102:return this.ROR(this.zp.bind(this));case 104:return this.PLA();case 105:return this.ADC(this.imm);case 106:return this.ROR_A();case 108:return this.JMP_IND();case 109:return this.ADC(this.abs.bind(this));case 110:return this.ROR(this.abs.bind(this));case 112:return this.br(p,1);case 113:return this.ADC(this.izy.bind(this));case 117:return this.ADC(this.zpx.bind(this));case 118:return this.ROR(this.zpx);case 120:return this.flag(o,1);case 121:return this.ADC(this.aby.bind(this));case 125:return this.ADC(this.abx.bind(this));case 126:return this.ROR(this._abx.bind(this));case 129:return this.st(_[0],this.izx.bind(this));case 132:return this.st(f[0],this.zp.bind(this));case 133:return this.st(_[0],this.zp.bind(this));case 134:return this.st(y[0],this.zp.bind(this));case 136:return this.dec(f);case 138:return this.tr(y,_);case 140:return this.st(f[0],this.abs.bind(this));case 141:return this.st(_[0],this.abs.bind(this));case 142:return this.st(y[0],this.abs.bind(this));case 144:return this.br(h,0);case 145:return this.st_A_izy();case 148:return this.st(f[0],this.zpx.bind(this));case 149:return this.st(_[0],this.zpx.bind(this));case 150:return this.st(y[0],this.zpy.bind(this));case 152:return this.tr(f,_);case 153:return this.st_A_aby();case 154:return this.tr(y,l);case 157:return this.st_A_abx();case 160:return this.ld(f,this.imm.bind(this));case 161:return this.ld(_,this.izx.bind(this));case 162:return this.ld(y,this.imm.bind(this));case 164:return this.ld(f,this.zp.bind(this));case 165:return this.ld(_,this.zp.bind(this));case 166:return this.ld(y,this.zp.bind(this));case 168:return this.tr(_,f);case 169:return this.ld(_,this.imm.bind(this));case 170:return this.tr(_,y);case 172:return this.ld(f,this.abs.bind(this));case 173:return this.ld(_,this.abs.bind(this));case 174:return this.ld(y,this.abs.bind(this));case 176:return this.br(h,1);case 177:return this.ld(_,this.izy.bind(this));case 180:return this.ld(f,this.zpx.bind(this));case 181:return this.ld(_,this.zpx.bind(this));case 182:return this.ld(y,this.zpy.bind(this));case 184:return this.flag(p,0);case 185:return this.ld(_,this.aby.bind(this));case 186:return this.tr(l,y);case 188:return this.ld(f,this.abx.bind(this));case 189:return this.ld(_,this.abx.bind(this));case 190:return this.ld(y,this.aby.bind(this));case 192:return this.cmp(f[0],this.imm.bind(this));case 193:return this.cmp(_[0],this.izx.bind(this));case 196:return this.cmp(f[0],this.zp.bind(this));case 197:return this.cmp(_[0],this.zp.bind(this));case 198:return this.DEC(this.zp.bind(this));case 200:return this.inc(f);case 201:return this.cmp(_[0],this.imm.bind(this));case 202:return this.dec(y);case 204:return this.cmp(f[0],this.abs.bind(this));case 205:return this.cmp(_[0],this.abs.bind(this));case 206:return this.DEC(this.abs.bind(this));case 208:return this.br(a,0);case 209:return this.cmp(_[0],this.izy.bind(this));case 213:return this.cmp(_[0],this.zpx.bind(this));case 214:return this.DEC(this.zpx.bind(this));case 216:return this.flag(c,0);case 217:return this.cmp(_[0],this.aby.bind(this));case 221:return this.cmp(_[0],this.abx.bind(this));case 222:return this.DEC(this._abx.bind(this));case 224:return this.cmp(y[0],this.imm.bind(this));case 225:return this.SBC(this.izx.bind(this));case 228:return this.cmp(y[0],this.zp.bind(this));case 229:return this.SBC(this.zp.bind(this));case 230:return this.INC(this.zp.bind(this));case 232:return this.inc(y);case 233:return this.SBC(this.imm);case 234:return this.NOP();case 236:return this.cmp(y[0],this.abs.bind(this));case 237:return this.SBC(this.abs.bind(this));case 238:return this.INC(this.abs.bind(this));case 240:return this.br(a,1);case 241:return this.SBC(this.izy.bind(this));case 245:return this.SBC(this.zpx.bind(this));case 246:return this.INC(this.zpx.bind(this));case 248:return this.flag(c,1);case 249:return this.SBC(this.aby.bind(this));case 253:return this.SBC(this.abx.bind(this));case 254:return this.INC(this._abx.bind(this));default:return console.log("Invalid OPcode! PC:",b[0]," OOP:",this.rd(b[0]-1)),this.NOP()}},S.prototype.power=function(){this.remaininhCycles=0,g.set(4),_[0]=0,y[0]=0,f[0]=0,l[0]=0,m.fill(255),this.nmi=!1,this.irq=!1,this.INT(s)},S.prototype.run_frame=function(){for(this.remaininhCycles+=29781;this.remaininhCycles>0;)this.nmi?this.INT(r):this.irq&&g.index(o)&&this.INT(e),this.exec()},t.exports=S},function(t,i){var r=0,s=1;var e=[4286348412,4294705152,4290510848,4290521156,4286840980,4280287400,4278194344,4278195336,4278202448,4278220800,4278216704,4278212608,4283973632,4278190080,4278190080,4278190080,4290559164,4294473728,4294465536,4294722664,4291559640,4283957476,4278204664,4279262436,4278221996,4278237184,4278233088,4282689536,4287137792,4278190080,4278190080,4278190080,4294506744,4294753340,4294740072,4294473880,4294473976,4288174328,4283988216,4282687740,4278237432,4279826616,4283750488,4288215128,4292405248,4286085240,4278190080,4278190080,4294769916,4294763684,4294490296,4294490328,4294490360,4290815224,4289777904,4289257724,4286109944,4286118104,4290312376,4292409528,4294769664,4294498552,4278190080,4278190080],n=function(){this.id=new Uint8Array(1),this.x=new Uint8Array(1),this.y=new Uint8Array(1),this.tile=new Uint8Array(1),this.attr=new Uint8Array(1),this.dataL=new Uint8Array(1),this.dataH=new Uint8Array(1)};n.prototype.copy=function(t){this.id[0]=t.id[0],this.x[0]=t.x[0],this.y[0]=t.y[0],this.tile[0]=t.tile[0],this.attr[0]=t.attr[0],this.dataL[0]=t.dataL[0],this.dataH[0]=t.dataH[0]};var h=function(){this.data=0};h.prototype.set_nt=function(t){t&=3,this.data&=-4,this.data|=t},h.prototype.get_nt=function(t){return 3&this.data},h.prototype.set_incr=function(t){this.data&=-5,this.data|=t<<2},h.prototype.get_incr=function(){return(4&this.data)>>2},h.prototype.set_sprTbl=function(t){this.data&=-9,this.data|=t<<3},h.prototype.get_sprTbl=function(){return(8&this.data)>>3},h.prototype.set_bgTbl=function(t){data&=-17,data|=t<<4},h.prototype.get_bgTbl=function(){return(16&this.data)>>4},h.prototype.set_sprSz=function(t){this.data&=-33,this.data|=t<<5},h.prototype.get_sprSz=function(){return(32&this.data)>>5},h.prototype.set_slave=function(t){this.data&=-65,this.data|=t<<6},h.prototype.get_slave=function(){return(32&v)>>6},h.prototype.set_nmi=function(t){this.data&=-129,this.data|=t<<7},h.prototype.get_nmi=function(){return(128&this.data)>>7},h.prototype.set_r=function(t){this.data=t},h.prototype.get_r=function(t){return this.data};var a=function(){this.data=0};a.prototype.set_gray=function(t){this.data&=-2,this.data|=t},a.prototype.get_gray=function(t){return 1&this.data},a.prototype.set_bgLeft=function(t){this.data&=-3,this.data|=t<<1},a.prototype.get_bgLeft=function(){return(2&this.data)>>1},a.prototype.set_sprLeft=function(t){this.data&=-5,this.data|=t<<2},a.prototype.get_sprLeft=function(){return(4&this.data)>>2},a.prototype.set_bg=function(t){this.data&=-9,this.data|=t<<3},a.prototype.get_bg=function(){return(8&this.data)>>3},a.prototype.set_spr=function(t){data&=-17,data|=t<<4},a.prototype.get_spr=function(){return(16&this.data)>>4},a.prototype.set_red=function(t){this.data&=-33,this.data|=t<<5},a.prototype.get_red=function(){return(32&this.data)>>5},a.prototype.set_green=function(t){this.data&=-65,this.data|=t<<6},a.prototype.get_green=function(){return(64&v)>>6},a.prototype.set_blue=function(t){this.data&=-129,this.data|=t<<7},a.prototype.get_blue=function(){return(128&this.data)>>7},a.prototype.set_r=function(t){this.data=t},a.prototype.get_r=function(t){return this.data};var o=function(){this.data=0};o.prototype.set_bus=function(t){t&=31,this.data&=~(31&t),this.data|=t},o.prototype.get_bus=function(){return 31&this.data},o.prototype.set_sprOvf=function(t){this.data&=-33,this.data|=t<<5},o.prototype.get_sprOvf=function(t){return(32&this.data)>>5},o.prototype.set_sprHit=function(t){this.data&=-65,this.data|=t<<6},o.prototype.get_sprHit=function(t){return(64&this.data)>>6},o.prototype.get_vBlank=function(t){return(128&this.data)>>7},o.prototype.set_vBlank=function(t){this.data&=-129,this.data|=t<<7},o.prototype.get_r=function(){return this.data},o.prototype.set_r=function(t){this.data=t};var c=function(){this.data=0};c.prototype.set_cX=function(t){t&=31,this.data&=-32,this.data|=t},c.prototype.get_cX=function(t){return 31&this.data},c.prototype.set_cY=function(t){this.data&=-993,this.data|=t<<5&992},c.prototype.get_cY=function(){return(992&this.data)>>5},c.prototype.set_nt=function(t){this.data&=-3073,this.data|=t<<10&3072},c.prototype.get_nt=function(){return(3072&this.data)>>10},c.prototype.set_fY=function(t){this.data&=-28673,this.data|=t<<12&28672},c.prototype.get_fY=function(){return(28672&this.data)>>12},c.prototype.set_l=function(t){t&=255,this.data&=-256,this.data|=t},c.prototype.get_l=function(t){return 255&this.data},c.prototype.set_h=function(t){this.data&=-32513,this.data|=t<<8&32512},c.prototype.get_h=function(){return(32512&this.data)>>8},c.prototype.set_addr=function(t){t&=16383,this.data&=-16384,this.data|=t},c.prototype.get_addr=function(){return 16383&this.data},c.prototype.set_r=function(t){this.data=t},c.prototype.get_r=function(){return this.data};var p=new Uint32Array(61440),u=new Uint8Array(2048),d=new Uint8Array(32),_=new Uint8Array(256),y=new Array(8),f=new Array(8),l=new c,g=new c,b=0,m=new Uint8Array(1),A=new h,w=new a,k=new o,z=0,x=0,R=0,S=0,U=new Uint8Array(1),T=new Uint8Array(1),L=new Uint16Array(1),O=new Uint16Array(1),E=!1,C=!1,P=0,D=0,I=0,F=new Uint16Array(4);function N(){return w.get_bg()||w.get_spr()}function B(){return A.get_sprSz()?16:8}function M(){return 8192|4095&l.get_r()}function Y(){L[0]=65280&L[0]|R,O[0]=65280&O[0]|S,E=1&x,C=2&x}function H(t,i){return t>>i&1}var X=function(t){this.nes=t};X.prototype.set_display=function(t){this.display=t},X.prototype.nt_mirror=function(t){switch(this.mirroring){case r:return t%2048;case s:return(t/2&1024)+t%1024;default:return t-8192}},X.prototype.debugInfo=function(){console.log("nt:",z," at:",x," bgL:",R," bgH:",S,"vAddr:",l.get_r(),"mask:",w.get_r(),"status:",k.get_r()),console.log("atShiftL:",U[0],"atShiftH:",T[0],"bgShiftL:",L[0],"bgShiftH:",O[0]),console.log("atLatchL:",E>0,"atLatchH:",C>0,"scanline:",P,"dot:",D,"frameOdd:",I>0)},X.prototype.debugPixels=function(){console.log(p[0]+"   "+p[1])};var j=new Uint8Array(1);X.prototype.load_sprites=function(){for(var t,i=0;i<8;i++)y[i].copy(f[i]),t=16==B()?4096*(1&y[i].tile[0])+16*(-2&y[i].tile[0]):4096*A.get_sprTbl()+16*y[i].tile[0],j[0]=0,j[0]=(P-y[i].y[0])%B(),128&y[i].attr[0]&&(j[0]^=B()-1),t+=j[0]+(8&j[0]),y[i].dataL[0]=this.rd(t+0),y[i].dataH[0]=this.rd(t+8)};var G=new Uint8Array(1),q=new Uint8Array(1),J=new Uint8Array(1),W=new Uint8Array(1);X.prototype.pixel=function(){J[0]=0,W[0]=0;var t=0,i=D-2;if(P<240&&i>=0&&i<256){if(!w.get_bg()||!w.get_bgLeft()&&i<8||(J[0]=H(O[0],15-b)<<1|H(L[0],15-b),J[0]&&(J[0]|=(H(T[0],7-b)<<1|H(U[0],7-b))<<2)),w.get_spr()&&(w.get_sprLeft()||!(i<8)))for(var r=7;r>=0;r--)64!=y[r].id[0]&&(G[0]=0,G[0]=i-y[r].x[0],G[0]>=8||(64&y[r].attr[0]&&(G[0]^=7),q[0]=0,q[0]=H(y[r].dataH[0],7-G[0])<<1|H(y[r].dataL[0],7-G[0]),0!=q[0]&&(0==y[r].id[0]&&J[0]&&255!=i&&k.set_sprHit(!0),q[0]|=(3&y[r].attr[0])<<2,W[0]=q[0]+16,t=32&y[r].attr[0])));!W[0]||0!=J[0]&&0!=t||(J[0]=W[0]);var s=this.rd(16128+(N()?J[0]:0));p[256*P+i]=e[s]}L[0]<<=1,O[0]<<=1,U[0]=U[0]<<1|E>0,T[0]=T[0]<<1|C>0},X.prototype.scanline_cycle=function(t){if(2==t&&1==D)k.set_vBlank(!0),A.get_nmi()&&this.nes.cpu.set_nmi();else if(1==t&&0==D)null!=this.display&&this.display.draw(p);else if(0==t||3==t){switch(D){case 1:!function(){for(var t=0;t<=8;t++)f[t].id[0]=64,f[t].y[0]=255,f[t].tile[0]=255,f[t].attr[0]=255,f[t].x[0]=255,f[t].dataL[0]=0,f[t].dataH[0]=0}(),3==t&&(k.set_sprOvf(!1),k.set_sprHit(!1));break;case 257:!function(){for(var t=0,i=0;i<64;i++){var r=(261==P?-1:P)-_[4*i+0];if(r>=0&&r<B()&&(f[t].id[0]=i,f[t].y[0]=_[4*i+0],f[t].tile[0]=_[4*i+1],f[t].attr[0]=_[4*i+2],f[t].x[0]=_[4*i+3],++t>8)){k.set_sprOvf(1);break}}}();break;case 321:this.load_sprites()}if(D>=2&&D<=255||D>=322&&D<=337)switch(this.pixel(),D%8){case 1:F[t]=M(),Y();break;case 2:z=this.rd(F[t]);break;case 3:F[t]=9152|l.get_nt()<<10|l.get_cY()/4<<3|l.get_cX()/4;break;case 4:x=this.rd(F[t]),2&l.get_cY()&&(x>>=4),2&l.get_cX()&&(x>>=2);break;case 5:F[t]=4096*A.get_bgTbl()+16*z+l.get_fY();break;case 6:R=this.rd(F[t]);break;case 7:F[t]+=8;break;case 0:S=this.rd(F[t]),N()&&(31==l.get_cX()?l.set_r(1055^l.get_r()):l.set_cX(l.get_cX()+1))}else 256==D?(this.pixel(),S=this.rd(F[t]),N()&&(l.get_fY()<7?l.set_fY(l.get_fY()+1):(l.set_fY(0),31==l.get_cY()?l.set_cY(0):29==l.get_cY()?(l.set_cY(0),l.set_nt(2^l.get_nt())):l.set_cY(l.get_cY()+1)))):257==D?(this.pixel(),Y(),N()&&l.set_r(-1056&l.get_r()|1055&g.get_r())):D>=280&&D<=304?3==t&&N()&&l.set_r(-31713&l.get_r()|31712&g.get_r()):1==D?(F[t]=M(),3==t&&k.set_vBlank(!1)):321==D||339==D?F[t]=M():338==D?z=this.rd(F[t]):340==D&&(z=this.rd(F[t]),3==t&&N()&&I&&D++);260==D&&N()&&this.nes.cartridge.signal_scanline()}},X.prototype.rd=function(t){return t<=8191?this.nes.cartridge.chr_access(0,t):t>=8192&t<=16127?u[this.nt_mirror(t)]:t>=16128&&t<=16383?(16==(19&t)&&(t&=-17),d[31&t]&(w.get_gray()?48:255)):0},X.prototype.wr=function(t,i){t<=8191?this.nes.cartridge.chr_access(1,t,i):t>=8192&&t<=16127?u[this.nt_mirror(t)]=i:t>=16128&&t<=16383&&(16==(19&t)&&(t&=-17),d[31&t]=i)},X.prototype.step=function(){P>=0&&P<=239?this.scanline_cycle(0):240==P?this.scanline_cycle(1):241==P?this.scanline_cycle(2):261==P&&this.scanline_cycle(3),++D>340&&(D%=341,++P>261&&(P=0,I^=1))};var V=new Uint8Array(1),K=new Uint8Array(1),Z=new Uint8Array(1),Q=new Uint8Array(1),$=new Uint8Array(1),tt=new Uint8Array(1),it=0,rt=0,st=0;X.prototype.access=function(t,i,r){if(t)switch(st=$,rt=Z,(it=V)[0]=r,i){case 0:A.set_r(r),g.set_nt(A.get_nt());break;case 1:w.set_r(r);break;case 3:m[0]=r;break;case 4:_[m[0]++]=r;break;case 5:st[0]?(g.set_fY(7&r),g.set_cY(r>>3)):(b=7&r,g.set_cX(r>>3)),st[0]=!st[0];break;case 6:st[0]?(g.set_l(r),l.set_r(g.get_r())):g.set_h(63&r),st[0]=!st[0];break;case 7:this.wr(l.get_addr(),r),l.set_addr(l.get_addr()+(A.get_incr()?32:1))}else switch(it=K,st=tt,rt=Q,i){case 2:it[0]=31&it[0]|k.get_r(),k.set_vBlank(0),st[0]=0;break;case 4:it[0]=_[m[0]];break;case 7:l.get_addr()<=16127?(it[0]=rt[0],rt[0]=this.rd(l.get_addr())):it[0]=rt[0]=this.rd(l.get_addr()),l.set_addr(l.get_addr()+(A.get_incr()?32:1))}return it[0]},X.prototype.reset=function(){I=!1,P=D=0,A.set_r(0),w.set_r(0),k.set_r(0),p.fill(0),u.fill(255),_.fill(0);for(var t=0;t<=8;++t)f[t]=new n,y[t]=new n;console.log("reset")},X.prototype.set_mirroring_vertical=function(){this.mirroring=r},X.prototype.set_mirroring_horizontal=function(){this.mirroring=s},t.exports=X},function(t,i,r){var s=r(4),e=function(t){this.nes=t,this.mapper=null,this.rom=null};e.prototype.load=function(t){this.rom=t;let i=240&t[7]|t[6]>>4;switch(this.mapper=null,this.nes.ppu.reset(),console.log("mapper:",i),i){case 0:this.mapper=new s.Mapper0(this.nes,t),this.mapper.init();break;case 2:this.mapper=new s.Mapper2(this.nes,t),this.mapper.init()}this.nes.cpu.power()},e.prototype.loadUrl=function(t){},e.prototype.access=function(t,i,r){return t?this.mapper.write(i,r):this.mapper.read(i)},e.prototype.chr_access=function(t,i,r){return t?this.mapper.chr_write(i,r):this.mapper.chr_read(i)},e.prototype.signal_scanline=function(){},t.exports=e},function(t,i){var r=function(t,i){this.prgMap=new Int32Array(4),this.chrMap=new Int32Array(8),this.nes=t,this.rom=i,this.prgSize=16384*i[4],this.chrSize=8192*i[5],this.prgRamSize=i[8]?8192*i[8]:8192,1&i[6]?t.ppu.set_mirroring_vertical():t.ppu.set_mirroring_horizontal(),this.prg=i.subarray(16),this.prgRam=new Uint8Array(this.prgRamSize),this.chrSize>0?this.chr=i.subarray(16+this.prgSize):(this.chrRam=!0,this.chrSize=8192,this.chr=new Uint8Array(this.chrSize))};r.prototype.read=function(t){return t>=32768?this.prg[this.prgMap[(t-32768)/8192|0]+(t-32768)%8192]:this.prgRam[t-24576]},r.prototype.write=function(t,i){return i},r.prototype.chr_read=function(t){var i=this.chrMap[t/1024|0]+t%1024;return this.chr[i]},r.prototype.chr_write=function(t,i){return i},r.prototype.map_prg=function(t,i,r){r<0&&(r=this.prgSize/(1024*t)+r);for(var s=0;s<t/8;++s)this.prgMap[t/8*i+s]=(1024*t*r+8192*s)%this.prgSize},r.prototype.map_prg_32=function(t,i){this.map_prg(32,t,i)},r.prototype.map_prg_16=function(t,i){this.map_prg(16,t,i)},r.prototype.map_prg_8=function(t,i){this.map_prg(8,t,i)},r.prototype.map_chr=function(t,i,r){for(var s=0;s<t;++s)this.chrMap[t*i+s]=(1024*t*r+1024*s)%this.chrSize},r.prototype.map_chr_8=function(t,i){this.map_chr(8,t,i)},r.prototype.map_chr_4=function(t,i){this.map_chr(4,t,i)},r.prototype.map_chr_2=function(t,i){this.map_chr(2,t,i)},r.prototype.map_chr_1=function(t,i){this.map_chr(1,t,i)},r.prototype.signal_scanline=function(){};var s=function(t,i){r.call(this,t,i)};(s.prototype=Object.create(r.prototype)).init=function(){this.map_prg_32(0,0),this.map_chr_8(0,0)},s.prototype.constructor=s;var e=function(t,i){r.call(this,t,i),this.regs=new Uint8Array(1),this.vertical_mirroring=!1};(e.prototype=Object.create(r.prototype)).run=function(){this.map_prg_16(0,15&this.regs[0]),this.map_prg_16(1,15),this.map_chr_8(0,0),this.vertical_mirroring?this.nes.ppu.set_mirroring_vertical():this.nes.ppu.set_mirroring_horizontal()},e.prototype.init=function(){this.regs[0]=0,this.vertical_mirroring=1&this.rom[6],this.run()},e.prototype.write=function(t,i){return 32768&t&&(this.regs[0]=i,this.run()),i},e.prototype.chr_write=function(t,i){return this.chr[t]=i},t.exports={Mapper0:s,Mapper2:e}},function(t,i){function r(t){this.gl=t}r.prototype.createShader=function(t,i,r){var s=(t=this.gl).createShader(i);if(t.shaderSource(s,r),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){var e=t.getShaderInfoLog(s);return console.log("无法编译 WebGL 程序。 \n\n"+e),t.deleteShader(s),null}return s},r.prototype.initShader=function(t,i){var r=this.createShader(this.gl,this.gl.VERTEX_SHADER,t),s=this.createShader(this.gl,this.gl.FRAGMENT_SHADER,i);if(!r||!s)return null;var e=this.gl.createProgram();if(!e)return null;if(this.gl.attachShader(e,r),this.gl.attachShader(e,s),this.gl.linkProgram(e),!this.gl.getProgramParameter(e,this.gl.LINK_STATUS)){var n=this.gl.getProgramInfoLog(e);return console.log("链接程序失败："+n),this.gl.deleteProgram(e),this.gl.deleteShader(s),this.gl.deleteShader(r),null}this.gl.useProgram(e),this.program=e},r.prototype.draw=function(t){var i=this.gl;this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clear(i.COLOR_BUFFER_BIT);var r=this.program,s=this.gl.getAttribLocation(r,"a_position"),e=this.gl.getUniformLocation(r,"u_matrix"),n=(this.gl.getUniformLocation(r,"u_texture"),this.gl.createBuffer());this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,0,0);var h=new Uint8Array(t.buffer);this.createSolidTexture(this.gl,h);var a=this.gl.canvas.width,o=this.gl.canvas.height,c=0/this.gl.canvas.width*2-1,p=0/this.gl.canvas.height*-2+1,u=a/this.gl.canvas.width*2,d=o/this.gl.canvas.height*-2;this.gl.uniformMatrix3fv(e,!1,[u,0,0,0,d,0,c,p,1]),this.gl.drawArrays(this.gl.TRIANGLES,0,6)},r.prototype.createSolidTexture=function(t,i){var r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.canvas.width,t.canvas.height,0,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),r},r.prototype.init=function(){this.initShader("\n    attribute vec2 a_position;\n    uniform vec2 u_resolution;\n    uniform mat3 u_matrix;\n    varying vec2 v_texCoord;\n      void main() {\n          gl_Position = vec4(u_matrix * vec3(a_position, 1), 1);\n          v_texCoord = a_position;\n      }\n   ","\n    precision mediump float;\n    uniform sampler2D u_image;\n    varying vec2 v_texCoord;\n\n    void main() {\n        gl_FragColor = texture2D(u_image, v_texCoord);\n    } \n  "),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),console.log("GL init")},t.exports=r},function(t,i){function r(t){this.nes=t,this.key_up=0,this.key_down=0,this.key_left=0,this.key_right=0,this.key_select=0,this.key_start=0,this.key_a=0,this.key_b=0}r.prototype.press=function(t){switch(t){case 1:this.key_up=1;break;case 2:this.key_down=1;break;case 3:this.key_left=1;break;case 4:this.key_right=1;break;case 5:this.key_select=1;break;case 6:this.key_start=1;break;case 7:this.key_a=1;break;case 8:this.key_b=1}},r.prototype.release=function(t){switch(t){case 1:this.key_up=0;break;case 2:this.key_down=0;break;case 3:this.key_left=0;break;case 4:this.key_right=0;break;case 5:this.key_select=0;break;case 6:this.key_start=0;break;case 7:this.key_a=0;break;case 8:this.key_b=0}},r.prototype.get_joypad_state=function(){var t=new Uint8Array(1);return t[0]|=this.key_a<<0,t[0]|=this.key_b<<1,t[0]|=this.key_select<<2,t[0]|=this.key_start<<3,t[0]|=this.key_up<<4,t[0]|=this.key_down<<5,t[0]|=this.key_left<<6,t[0]|=this.key_right<<7,t[0]},t.exports=r},function(t,i){var r=new Uint8Array(2),s=!1;function e(t){this.nes=t}e.prototype.read_state=function(t){if(s)return 64|1&this.nes.player(t).get_joypad_state();var i=new Uint8Array(1);return i[0]=64|1&r[t],r[t]=128|r[t]>>1,i[0]},e.prototype.write_strobe=function(t){if(s&&!t)for(var i=0;i<2;i++)r[i]=this.nes.player(i).get_joypad_state();s=t},t.exports=e}]);